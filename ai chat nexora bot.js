// Chatbot functionality with enhanced AI features
document.addEventListener('DOMContentLoaded', function() {
    const chatWidget = document.getElementById('chatWidget');
    const openChatBtn = document.getElementById('openChatBtn');
    const closeChatBtn = document.getElementById('closeChatBtn');
    const userInput = document.getElementById('userInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const chatMessages = document.getElementById('chatMessages');

    const responses = {
        default: "ุนุฐุฑุงูุ ูู ุฃููู ุณุคุงูู. ูู ููููู ุฅุนุงุฏุฉ ุตูุงุบุชู ุจุทุฑููุฉ ุฃุฎุฑูุ ูููููู ูุณุงุนุฏุชู ูู ูุนุฑูุฉ ุงููุฒูุฏ ุนู ุฎุฏูุงุชูุงุ ุฃุณุนุงุฑูุงุ ุฃู ููููุฉ ุงูุชูุงุตู ูุนูุง.",
        greetings: [
            "ูุฑุญุจุงู! ููู ูููููู ูุณุงุนุฏุชู ุงููููุ",
            "ุฃููุงู ุจู ูู Nexora! ููู ุญุงููุ",
            "ูุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู! ูุณุนุฏูู ูุณุงุนุฏุชู.",
            "ููุง ูุบูุง! ููู ูููููู ุฎุฏูุชู ุงููููุ",
            "ุฃููุงู ูุณููุงู! ุชุดุฑููุง ุจุฎุฏูุชู.",
            "ุตุจุงุญ ุงูููุฑ! ููู ูููููู ูุณุงุนุฏุชูุ",
            "ูุณุงุก ุงูุฎูุฑ! ุฃูุง ููุง ููุณุงุนุฏุชู.",
            "ูุงููุง! ููู ุญุงูู ุงููููุ",
            "ุญูุงู ุงููู! ููู ูููููู ูุณุงุนุฏุชูุ"
        ],
        services: {
            general: "ููุฏู ูุฌููุนุฉ ูุชูุงููุฉ ูู ุงูุฎุฏูุงุช ุงูุชุณููููุฉ ูุงูุฅุจุฏุงุนูุฉ:",
            translation: "ุฎุฏูุงุช ุงูุชุฑุฌูุฉ ุงูุงุญุชุฑุงููุฉ ุชุดูู:\n- ุชุฑุฌูุฉ ุงูููุงูุน ุงูุฅููุชุฑูููุฉ\n- ุชุฑุฌูุฉ ุงููุญุชูู ุงูุชุณูููู\n- ุชุฑุฌูุฉ ุงููุซุงุฆู ุงููุงููููุฉ\n- ุชุฑุฌูุฉ ุงููุญุชูู ุงูุชููู\n- ุฎุฏูุงุช ุงูุชุฏููู ุงููุบูู",
            marketing: "ุฎุฏูุงุช ุงูุชุณููู ุงูุฑููู ุชุดูู:\n- ุฅุฏุงุฑุฉ ูุณุงุฆู ุงูุชูุงุตู ุงูุงุฌุชูุงุนู\n- ุญููุงุช ุงูุฅุนูุงูุงุช ุงููุฏููุนุฉ\n- ุชุญุณูู ูุญุฑูุงุช ุงูุจุญุซ (SEO)\n- ุชุณููู ุงููุญุชูู\n- ุฅุฏุงุฑุฉ ุญููุงุช ุงูุจุฑูุฏ ุงูุฅููุชุฑููู",
            content: "ุฎุฏูุงุช ูุชุงุจุฉ ุงููุญุชูู ุชุดูู:\n- ูุชุงุจุฉ ุงูููุงูุงุช ูุงููุฏููุงุช\n- ูุญุชูู ูุณุงุฆู ุงูุชูุงุตู ุงูุงุฌุชูุงุนู\n- ูุตูุต ุฅุนูุงููุฉ\n- ูุตู ุงูููุชุฌุงุช\n- ุงููุญุชูู ุงูุชููู",
            design: "ุฎุฏูุงุช ุงูุชุตููู ุงูุฅุจุฏุงุนู ุชุดูู:\n- ุชุตููู ุงููููุฉ ุงูุจุตุฑูุฉ\n- ุชุตููู ุงูููุงูุน ุงูุฅููุชุฑูููุฉ\n- ุชุตููู ูุณุงุฆู ุงูุชูุงุตู ุงูุงุฌุชูุงุนู\n- ุชุตููู ุงููุทุจูุนุงุช\n- ุชุตููู ุงูุฅุนูุงูุงุช"
        },
        pricing: {
            general: "ููุฏู ุฃุณุนุงุฑุงู ุชูุงูุณูุฉ ุชูุงุณุจ ูุฎุชูู ุงูููุฒุงููุงุช. ุงูุฃุณุนุงุฑ ุชุนุชูุฏ ุนูู ูุทุงู ุงููุดุฑูุน ูุงุญุชูุงุฌุงุชู ุงูุฎุงุตุฉ.",
            translation: "ุฃุณุนุงุฑ ุงูุชุฑุฌูุฉ ุชุจุฏุฃ ูู 0.08$ ูููููุฉุ ูุน ุฎุตููุงุช ูููุดุงุฑูุน ุงููุจูุฑุฉ.",
            marketing: "ุจุงูุงุช ุงูุชุณููู ุงูุฑููู ุชุจุฏุฃ ูู 500$ ุดูุฑูุงูุ ูุชุดูู ุฅุฏุงุฑุฉ ูุงููุฉ ูุญุณุงุจุงุช ุงูุชูุงุตู ุงูุงุฌุชูุงุนู.",
            content: "ุฃุณุนุงุฑ ูุชุงุจุฉ ุงููุญุชูู ุชุจุฏุฃ ูู 0.10$ ูููููุฉุ ูุน ุจุงูุงุช ุดูุฑูุฉ ูุฎุตุตุฉ.",
            design: "ุชุตููู ุงููููุฉ ุงูุจุตุฑูุฉ ูุจุฏุฃ ูู 1000$ุ ูุชุตููู ูุณุงุฆู ุงูุชูุงุตู ุงูุงุฌุชูุงุนู ูู 300$ ุดูุฑูุงู."
        },
        contact: {
            general: "ููููู ุงูุชูุงุตู ูุนูุง ุนุจุฑ ุนุฏุฉ ูููุงุช:",
            email: "ุงูุจุฑูุฏ ุงูุฅููุชุฑููู: info@nexora.com",
            phone: "ุงููุงุชู: +00000000000",
            social: "ุชุงุจุนูุง ุนูู:\nููุณุจูู: Nexora\nุฅูุณุชุบุฑุงู: @Nexora\nููููุฏ ุฅู: Nexora",
            office: "ููุฑูุง ูู ูุตุฑ",
            form: "ููููู ุฃูุถุงู ููุก ูููุฐุฌ ุงูุชูุงุตู ูู ุงูุฃุณูู ูุณูุฑุฏ ุนููู ุฎูุงู 24 ุณุงุนุฉ."
        },
        portfolio: {
            translation: "ูุฏููุง ุฎุจุฑุฉ ูู ุชุฑุฌูุฉ ููุงูุน ูุดุฑูุงุช ุนุงูููุฉ ูุชูุงุฑูุฑ ุณูููุฉ ููุคุณุณุงุช ูุจุฑู.",
            marketing: "ุญูููุง ูุฌุงุญุงุช ูุจูุฑุฉ ูู ุญููุงุช ุงูุชุณููู ุงูุฑูููุ ูุน ุฒูุงุฏุฉ ุงููุจูุนุงุช ุจูุณุจุฉ ุชุตู ุฅูู 150%.",
            content: "ูุชุจูุง ูุญุชูู ูุฃูุซุฑ ูู 10 ุดุฑูุฉ ูู ูุฎุชูู ุงููุฌุงูุงุช.",
            design: "ุตูููุง ูููุงุช ุจุตุฑูุฉ ูุนูุงูุงุช ุชุฌุงุฑูุฉ ุฑุงุฆุฏุฉ ูู ุงูุณูู."
        },
        team: "ูุฑูููุง ูุถู ูุฎุจุฉ ูู ุงููุชุฎุตุตูู ูู ูุฌุงูุงุช:\n- ุงูุชุฑุฌูุฉ ุงูุงุญุชุฑุงููุฉ\n- ุงูุชุณููู ุงูุฑููู\n- ูุชุงุจุฉ ุงููุญุชูู\n- ุงูุชุตููู ุงูุฅุจุฏุงุนู",
        process: {
            general: "ูุชุจุน ูููุฌูุฉ ุนูู ุงุญุชุฑุงููุฉ ุชุถูู ุฃูุถู ุงููุชุงุฆุฌ:",
            steps: "1. ุชุญููู ุงุญุชูุงุฌุงุชู\n2. ูุถุน ุงุณุชุฑุงุชูุฌูุฉ ูุฎุตุตุฉ\n3. ุงูุชูููุฐ ุจุงุญุชุฑุงููุฉ\n4. ุงููุฑุงุฌุนุฉ ูุงูุชุญุณูู\n5. ููุงุณ ุงููุชุงุฆุฌ"
        },
        services_questions: {
            general: {
                question: [
                    "ุงูู ุงูุฎุฏูุงุช ุงููู ุจุชูุฏูููุง",
                    "ุจุชูุฏููุง ุงูู",
                    "ูุง ูู ุฎุฏูุงุชูู",
                    "ุฎุฏูุงุชูู ุงูู",
                    "ุนูุฏูู ุงูู",
                    "ุจุชุนูููุง ุงูู ุจุงูุธุจุท",
                    "ุงูู ูุฌุงูุงุช ุดุบููู"
                ],
                answer: "ููุฏู ูุฌููุนุฉ ูุชูุงููุฉ ูู ุงูุฎุฏูุงุช ุงููุชููุฒุฉ ๐\n\n\n" +

                    "1๏ธโฃ ุฎุฏูุงุช ุงูุชุฑุฌูุฉ ุงูุงุญุชุฑุงููุฉ:\n" +
                    "   - ุชุฑุฌูุฉ ูุนุชูุฏุฉ ูููุซุงุฆู ุงููุงููููุฉ\n" +
                    "   - ุชุฑุฌูุฉ ุงูููุงูุน ูุงูุชุทุจููุงุช\n" +
                    "   - ุชุฑุฌูุฉ ุงููุญุชูู ุงูุชููู ูุงูุทุจู\n" +
                    "   - ุฎุฏูุงุช ุงูุชุนุฑูุจ ุงูุดุงูู\n\n\n" +

                    "2๏ธโฃ ุฎุฏูุงุช ุงูุชุณููู ุงูุฑููู:\n" +
                    "   - ุฅุฏุงุฑุฉ ุญุณุงุจุงุช ุงูุณูุดูุงู ููุฏูุง\n" +
                    "   - ุฅุฏุงุฑุฉ ุงูุญููุงุช ุงูุฅุนูุงููุฉ\n" +
                    "   - ุชุญุณูู ูุญุฑูุงุช ุงูุจุญุซ SEO\n" +
                    "   - ุงูุชุณููู ุนุจุฑ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู\n\n\n" +

                    "3๏ธโฃ ุฎุฏูุงุช ูุชุงุจุฉ ุงููุญุชูู:\n" +
                    "   - ูุชุงุจุฉ ุงูููุงูุงุช ูุงููุฏููุงุช\n" +
                    "   - ูุญุชูู ุงูุณูุดูุงู ููุฏูุง\n" +
                    "   - ูุตู ุงูููุชุฌุงุช ูุงูุฎุฏูุงุช\n" +
                    "   - ุงููุญุชูู ุงูุชููู ูุงูุชุณูููู\n\n\n" +

                    "4๏ธโฃ ุฎุฏูุงุช ุงูุชุตููู ุงูุฅุจุฏุงุนู:\n" +
                    "   - ุชุตููู ุงููููุฉ ุงูุจุตุฑูุฉ\n" +
                    "   - ุชุตููู ุงูููุงูุน ุงูุฅููุชุฑูููุฉ\n" +
                    "   - ุชุตููู ุงูุณูุดูุงู ููุฏูุง\n" +
                    "   - ุชุตููู ุงููุทุจูุนุงุช\n\n\n" +

                    "โจ ูููุฒุงุชูุง:\n" +
                    "   - ูุฑูู ูุญุชุฑู ูุชุฎุตุต\n" +
                    "   - ุฌูุฏุฉ ุนุงููุฉ ูู ุงูุชูููุฐ\n" +
                    "   - ุฃุณุนุงุฑ ุชูุงูุณูุฉ\n" +
                    "   - ุฏุนู ููู ูุณุชูุฑ\n" +
                    "   - ุชุณููู ูู ุงูููุนุฏ ุงููุญุฏุฏ\n\n\n" +

                    "ูููุฒูุฏ ูู ุงูุชูุงุตูู ุนู ุฃู ุฎุฏูุฉุ ููููู ุงูุณุคุงู ุนููุง ุจุดูู ูุญุฏุฏ ๐ซ"
            },
            prices: {
                packages: {
                    question: ["ุงูุจุงูุงุช", "ุนุฑูุถ ุงูุงุณุนุงุฑ", "ุจุงูุงุช ุงูุฎุฏูุงุช"],
                    answer: "ููุฏู ุจุงูุงุช ูุชููุนุฉ ุชูุงุณุจ ุฌููุน ุงูุงุญุชูุงุฌุงุช:\n\n\n" +

                        "1. ุงูุจุงูุฉ ุงูุฃุณุงุณูุฉ (500$ ุดูุฑูุงู):\n" +
                        "   - ุฅุฏุงุฑุฉ 3 ููุตุงุช ุชูุงุตู ุงุฌุชูุงุนู\n" +
                        "   - 15 ุชุตููู ุดูุฑูุงู\n" +
                        "   - ุชูุฑูุฑ ุดูุฑู\n\n\n" +

                        "2. ุงูุจุงูุฉ ุงููุชูุฏูุฉ (1000$ ุดูุฑูุงู):\n" +
                        "   - ุฅุฏุงุฑุฉ 5 ููุตุงุช ุชูุงุตู ุงุฌุชูุงุนู\n" +
                        "   - 30 ุชุตููู ุดูุฑูุงู\n" +
                        "   - ุญููุงุช ุฅุนูุงููุฉ\n" +
                        "   - ุชูุงุฑูุฑ ุฃุณุจูุนูุฉ\n\n\n" +

                        "3. ุงูุจุงูุฉ ุงูุงุญุชุฑุงููุฉ (2000$ ุดูุฑูุงู):\n" +
                        "   - ุฅุฏุงุฑุฉ ูุงููุฉ ูุฌููุน ุงูููุตุงุช\n" +
                        "   - ุชุตุงููู ุบูุฑ ูุญุฏูุฏุฉ\n" +
                        "   - ุงุณุชุฑุงุชูุฌูุฉ ุชุณููู ุดุงููุฉ\n" +
                        "   - ุชูุงุฑูุฑ ููููุฉ"
                },
                contact: {
                    question: ["ููู ุงุชูุงุตู", "ูุนูููุงุช ุงูุงุชุตุงู", "ุงุฑูุงู ุงูุชูุงุตู"],
                    answer: "ููููู ุงูุชูุงุตู ูุนูุง ูู ุฃู ููุช ๐\n\n\n" +

                        "๐ฑ ุงููุงุชุณุงุจ (ูุชุงุญ 24/7):\n" +
                        "- +20000000000\n" +
                        "- ุฑุฏ ููุฑู ููุญุงูุงุช ุงูุนุงุฌูุฉ\n\n\n" +

                        "๐ง ุงูุจุฑูุฏ ุงูุฅููุชุฑููู:\n" +
                        "- info@nexora.com\n" +
                        "- ูุชุงุจุนุฉ ูุณุชูุฑุฉ ููุฑุณุงุฆู\n\n\n" +

                        "๐ ุญุณุงุจุงุชูุง ุนูู ุงูุณูุดูุงู ููุฏูุง:\n" +
                        "- ููุณุจูู: https://www.facebook.com/profile.php?id=61575374715077\n" +
                        "- ุงูุณุชุฌุฑุงู: @Nexora\n" +
                        "- ููููุฏ ุฅู: https://www.linkedin.com/in/nexora-m-593039329/"
                }
            }
        },
        context_aware_responses: {
            pricing_after_service: {
                translation: "ุจูุงุกู ุนูู ุงูุชูุงูู ุจุฎุฏูุงุช ุงูุชุฑุฌูุฉุ ุฃูุฏ ุฅุฎุจุงุฑู ุฃู ุฃุณุนุงุฑูุง ุชุจุฏุฃ ูู 0.08$ ูููููุฉ ูุน ุฎุตููุงุช ุฎุงุตุฉ ูููุดุงุฑูุน ุงููุจูุฑุฉ. ูู ุชุฑูุฏ ูุนุฑูุฉ ุงููุฒูุฏ ุนู ุจุงูุงุชูุงุ",
                marketing: "ูุธุฑุงู ูุงูุชูุงูู ุจุงูุชุณููู ุงูุฑูููุ ูุฏููุง ุจุงูุงุช ุชุจุฏุฃ ูู 500$ ุดูุฑูุงู ุชุดูู ุฅุฏุงุฑุฉ ูุงููุฉ ูููุตุงุช ุงูุชูุงุตู ุงูุงุฌุชูุงุนู. ูู ุชุฑูุฏ ูุนุฑูุฉ ุชูุงุตูู ุงูุจุงูุงุชุ",
            }
        }
    };

    let conversationContext = {
        lastTopic: null,
        interests: [],
        suggestedServices: [],
        messageHistory: []
    };

    // Handle chat widget visibility
    openChatBtn.addEventListener('click', () => {
        chatWidget.style.display = 'flex';
        // Animation
        void chatWidget.offsetWidth;
        chatWidget.classList.add('active');
    });

    closeChatBtn.addEventListener('click', () => {
        chatWidget.classList.remove('active');
        setTimeout(() => {
            chatWidget.style.display = 'none';
        }, 300);
    });

    // Close chat when clicking outside
    document.addEventListener('click', function(event) {
        const isClickInsideChat = chatWidget.contains(event.target);
        const isClickOnButton = openChatBtn.contains(event.target);
        
        if (chatWidget.style.display === 'flex' && !isClickInsideChat && !isClickOnButton) {
            chatWidget.classList.remove('active');
            setTimeout(() => {
                chatWidget.style.display = 'none';
            }, 300);
        }
    });

    // Prevent chat from closing when clicking inside
    chatWidget.addEventListener('click', function(event) {
        event.stopPropagation();
    });

    // Enhanced message handling with context awareness
    function addMessage(message, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
        messageDiv.textContent = message;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function handleUserMessage() {
        const message = userInput.value.trim();
        if (message) {
            addMessage(message, true);
            userInput.value = '';
            processUserMessage(message);
        }
    }

    function analyzeMessage(message) {
        const keywords = {
            translation: ['ุชุฑุฌูุฉ', 'ูุชุฑุฌู', 'ูุบุงุช', 'ุชุนุฑูุจ'],
            marketing: ['ุชุณููู', 'ุงุนูุงู', 'ุณูุดูุงู', 'ุญููุงุช'],
            content: ['ูุญุชูู', 'ูุชุงุจุฉ', 'ููุงูุงุช'],
            design: ['ุชุตููู', 'ุดุนุงุฑ', 'ููุฌู', 'ูููุฉ'],
            pricing: ['ุณุนุฑ', 'ุชูููุฉ', 'ูู', 'ุงุณุนุงุฑ', 'ุจุงูุงุช'],
            contact: ['ุชูุงุตู', 'ุงุชุตุงู', 'ุฑูู', 'ุนููุงู']
        };

        for (const [category, words] of Object.entries(keywords)) {
            if (words.some(word => message.includes(word))) {
                if (!conversationContext.interests.includes(category)) {
                    conversationContext.interests.unshift(category);
                }
                return category;
            }
        }

        return null;
    }

    function processUserMessage(message) {
        message = message.trim().toLowerCase();
        const messageType = analyzeMessage(message);
        
        // Update context
        if (messageType) {
            conversationContext.lastTopic = messageType;
        }

        // Check for combined contexts
        if (messageType === 'pricing' && conversationContext.lastTopic) {
            const previousService = conversationContext.lastTopic;
            if (responses.context_aware_responses.pricing_after_service[previousService]) {
                setTimeout(() => {
                    addMessage(responses.context_aware_responses.pricing_after_service[previousService]);
                }, 500);
                return;
            }
        }

        // Handle greetings
        if (isGreeting(message)) {
            setTimeout(() => {
                const randomGreeting = responses.greetings[Math.floor(Math.random() * responses.greetings.length)];
                addMessage(randomGreeting);
            }, 500);
            return;
        }

        // Service specific responses
        if (messageType === 'translation' || messageType === 'marketing' || 
            messageType === 'content' || messageType === 'design') {
            setTimeout(() => {
                addMessage(responses.services[messageType]);
                // Add follow-up suggestion
                setTimeout(() => {
                    addMessage("ูู ุชุฑุบุจ ูู ูุนุฑูุฉ ุฃุณุนุงุฑ ูุฐู ุงูุฎุฏูุฉุ");
                }, 500);
            }, 500);
            return;
        }

        // Pricing responses with context
        if (messageType === 'pricing') {
            setTimeout(() => {
                if (conversationContext.lastTopic && conversationContext.lastTopic !== 'pricing') {
                    addMessage(responses.pricing[conversationContext.lastTopic]);
                } else {
                    addMessage(responses.pricing.general);
                }
            }, 500);
            return;
        }

        // Contact information
        if (messageType === 'contact') {
            setTimeout(() => {
                addMessage(responses.contact.general + "\n" + responses.contact.email + "\n" + 
                         responses.contact.phone + "\n" + responses.contact.social);
            }, 500);
            return;
        }

        // Default response
        setTimeout(() => {
            addMessage(responses.default);
        }, 500);
    }

    // Helper function to check for greetings
    function isGreeting(message) {
        const greetings = [
            "ูุฑุญุจุง", "ุงููุง", "ุงูุณูุงู", "ูุงู", "ููุง", "ุตุจุงุญ", "ูุณุงุก",
            "ุตุจุงุญ ุงูุฎูุฑ", "ูุณุงุก ุงูุฎูุฑ", "ุตุจุงุญ ุงูููุฑ", "ูุณุงุก ุงูููุฑ", 
            "ููู", "ุณูุงู", "ุญูุงู"
        ];
        return greetings.some(greeting => message.toLowerCase().includes(greeting));
    }

    // Event listeners
    sendMessageBtn.addEventListener('click', handleUserMessage);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            handleUserMessage();
        }
    });
});